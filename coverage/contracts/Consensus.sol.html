<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/Consensus.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Consensus.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/42</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/40</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/13</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/42</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.4.24;
&nbsp;
import "./interfaces/IBlockReward.sol";
import "./interfaces/IVoting.sol";
import "./ConsensusUtils.sol";
&nbsp;
/**
* @title Contract handling consensus logic
* @author LiorRabin
*/
contract Consensus is ConsensusUtils {
  /**
  * @dev Function to be called on contract initialization
  * @param _initialValidator address of the initial validator. If not set - msg.sender will be the initial validator
  */
<span class="fstat-no" title="function not covered" >  function initialize(address _initialValidator) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >    require(!isInitialized())</span>;
<span class="cstat-no" title="statement not covered" >    _setSystemAddress(0xffffFFFfFFffffffffffffffFfFFFfffFFFfFFfE)</span>;
<span class="cstat-no" title="statement not covered" >    _setCurrentCycle()</span>;
<span class="cstat-no" title="statement not covered" >    if (_initialValidator == address(0)) {</span>
<span class="cstat-no" title="statement not covered" >      _currentValidatorsAdd(msg.sender)</span>;
    } else {
<span class="cstat-no" title="statement not covered" >      _currentValidatorsAdd(_initialValidator)</span>;
    }
<span class="cstat-no" title="statement not covered" >    _setFinalized(true)</span>;
<span class="cstat-no" title="statement not covered" >    setInitialized(true)</span>;
  }
&nbsp;
  /**
  * @dev Function which returns the current validator addresses
  */
<span class="fstat-no" title="function not covered" >  function getValidators() external view returns(address[]) {</span>
<span class="cstat-no" title="statement not covered" >    return currentValidators();</span>
  }
&nbsp;
  /**
  * @dev See ValidatorSet.finalizeChange
  */
<span class="fstat-no" title="function not covered" >  function finalizeChange() external onlySystem notFinalized {</span>
<span class="cstat-no" title="statement not covered" >    if (newValidatorSetLength() &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >      _setCurrentValidators(newValidatorSet())</span>;
<span class="cstat-no" title="statement not covered" >      emit ChangeFinalized(currentValidators());</span>
    }
<span class="cstat-no" title="statement not covered" >    _setFinalized(true)</span>;
  }
&nbsp;
  /**
  * @dev Fallback function allowing to pay to this contract. Whoever sends funds is considered as "staking" and wanting to become a validator.
  */
<span class="fstat-no" title="function not covered" >  function () external payable {</span>
<span class="cstat-no" title="statement not covered" >    _delegate(msg.sender, msg.value, msg.sender)</span>;
  }
&nbsp;
  /**
  * @dev stake to become a validator.
  */
<span class="fstat-no" title="function not covered" >  function stake() external payable {</span>
<span class="cstat-no" title="statement not covered" >    _delegate(msg.sender, msg.value, msg.sender)</span>;
  }
&nbsp;
  /**
  * @dev delegate to a validator
  * @param _validator the address of the validator msg.sender is delegating to
  */
<span class="fstat-no" title="function not covered" >  function delegate(address _validator) external payable {</span>
<span class="cstat-no" title="statement not covered" >    _delegate(msg.sender, msg.value, _validator)</span>;
  }
&nbsp;
  /**
  * @dev Function to be called when a staker whishes to withdraw some of his staked funds
  * @param _amount the amount msg.sender wishes to withdraw from the contract
  */
<span class="fstat-no" title="function not covered" >  function withdraw(uint256 _amount) external {</span>
<span class="cstat-no" title="statement not covered" >    _withdraw(msg.sender, _amount, msg.sender)</span>;
  }
&nbsp;
  /**
  * @dev Function to be called when a delegator whishes to withdraw some of his staked funds for a validator
  * @param _validator the address of the validator msg.sender has delegating to
  * @param _amount the amount msg.sender wishes to withdraw from the contract
  */
<span class="fstat-no" title="function not covered" >  function withdraw(address _validator, uint256 _amount) external {</span>
<span class="cstat-no" title="statement not covered" >    _withdraw(msg.sender, _amount, _validator)</span>;
  }
&nbsp;
  /**
  * @dev Function to be called by the block reward contract each block to handle cycles and snapshots logic
  */
<span class="fstat-no" title="function not covered" >  function cycle(address _validator) external onlyBlockReward {</span>
<span class="cstat-no" title="statement not covered" >    _incBlockCounter(_validator)</span>;
<span class="cstat-no" title="statement not covered" >    if (_hasCycleEnded()) {</span>
<span class="cstat-no" title="statement not covered" >      IVoting(ProxyStorage(getProxyStorage()).getVoting()).onCycleEnd(currentValidators())</span>;
<span class="cstat-no" title="statement not covered" >      _setCurrentCycle()</span>;
<span class="cstat-no" title="statement not covered" >      _checkJail(currentValidators())</span>;
<span class="cstat-no" title="statement not covered" >      address[] memory newSet = pendingValidators();</span>
<span class="cstat-no" title="statement not covered" >      if (newSet.length &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >        _setNewValidatorSet(newSet)</span>;
      }
<span class="cstat-no" title="statement not covered" >      if (newValidatorSetLength() &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >        _setFinalized(false)</span>;
<span class="cstat-no" title="statement not covered" >        _setShouldEmitInitiateChange(true)</span>;
<span class="cstat-no" title="statement not covered" >        emit ShouldEmitInitiateChange();</span>
      }
<span class="cstat-no" title="statement not covered" >      IBlockReward(ProxyStorage(getProxyStorage()).getBlockReward()).onCycleEnd()</span>;
    }
  }
&nbsp;
  /**
  * @dev Function to be called by validators only to emit InitiateChange event (only if `shouldEmitInitiateChange` returns true)
  */
<span class="fstat-no" title="function not covered" >  function emitInitiateChange() external onlyValidator {</span>
<span class="cstat-no" title="statement not covered" >    require(shouldEmitInitiateChange())</span>;
<span class="cstat-no" title="statement not covered" >    require(newValidatorSetLength() &gt; 0)</span>;
<span class="cstat-no" title="statement not covered" >    emit InitiateChange(blockhash(block.number - 1), newValidatorSet());</span>
<span class="cstat-no" title="statement not covered" >    _setShouldEmitInitiateChange(false)</span>;
  }
&nbsp;
&nbsp;
  /**
  * @dev Function to be called by validators to update the validator fee, that's the fee cut the validator takes from his delegatots.
  * @param _amount fee percentage when 1e18 represents 100%.
  */
<span class="fstat-no" title="function not covered" >  function setValidatorFee(uint256 _amount) external onlyValidator {</span>
<span class="cstat-no" title="statement not covered" >    require (_amount &lt;= 1 * DECIMALS)</span>;
<span class="cstat-no" title="statement not covered" >    require(_amount &gt;= getMinValidatorFee())</span>;
<span class="cstat-no" title="statement not covered" >    _setValidatorFee(msg.sender, _amount)</span>;
  }
&nbsp;
  /**
  * @dev Function to be called by jailed validator, in order to be released from jail
  */
<span class="fstat-no" title="function not covered" >  function unJail() external onlyJailedValidator {</span>
<span class="cstat-no" title="statement not covered" >    require(getReleaseBlock(msg.sender) &lt;= getCurrentCycleEndBlock())</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >    _removeFromJail(msg.sender)</span>;
  }
&nbsp;
  /**
  * @dev Function to be called by current validators to be dropped from the next cycle in order to perform maintenance 
  */
<span class="fstat-no" title="function not covered" >  function maintenance() external onlyValidator {</span>
<span class="cstat-no" title="statement not covered" >    require(isJailed(msg.sender) == false)</span>;
<span class="cstat-no" title="statement not covered" >    _maintenance(msg.sender)</span>;
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jan 23 2024 13:38:02 GMT+0100 (GMT+01:00)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
